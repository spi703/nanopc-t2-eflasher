name: Build Custom EFlasher

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full unzip xz-utils wget mount util-linux

      - name: Download base EFlasher
        run: |
          # Ganti link ini dengan link resmi base eflasher NanoPC-T2
          wget http://download.friendlyelec.com/nanopc-t2-eflasher.img.gz -O base.img.gz
          gunzip base.img.gz
          mv base.img eflasher.img

      - name: Mount and inject OS + logo
        run: |
          mkdir -p mnt_boot mnt_root

          # offset sektor (contoh: boot=2048, rootfs=8192)
          BOOT_OFFSET=$((2048*512))
          ROOT_OFFSET=$((8192*512))

          # mount boot partition
          sudo mount -o loop,offset=$BOOT_OFFSET eflasher.img mnt_boot
          sudo cp assets/bootlogo.bmp mnt_boot/bootlogo.bmp
          sudo umount mnt_boot

          # mount rootfs partition
          sudo mount -o loop,offset=$ROOT_OFFSET eflasher.img mnt_root
          sudo rm -rf mnt_root/os/*
          sudo cp -r os/* mnt_root/os/
          sudo umount mnt_root

          sync

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: eflasher-${{ github.run_number }}
          name: "EFlasher Build ${{ github.run_number }}"
          draft: false
          prerelease: false
          files: eflasher.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
