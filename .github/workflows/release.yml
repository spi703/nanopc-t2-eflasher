name: Build Custom EFlasher

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full unzip xz-utils wget mount util-linux

      - name: Download base EFlasher
        run: |
          # ganti link ini dengan link resmi base eflasher NanoPC-T2
          wget http://download.friendlyelec.com/nanopc-t2-eflasher.img.gz -O base.img.gz
          gunzip base.img.gz
          mv base.img eflasher.img

      - name: Mount and inject OS + logo
        run: |
          mkdir mnt
          # offset partisi rootfs biasanya 8192 sektor (8192 * 512 byte)
          sudo mount -o loop,offset=$((8192*512)) eflasher.img mnt
          
          # ganti folder OS bawaan dengan os/ dari repo
          sudo rm -rf mnt/os/*
          sudo cp -r os/* mnt/os/

          # ganti bootlogo
          sudo cp assets/bootlogo.bmp mnt/bootlogo.bmp

          # sync dan unmount
          sync
          sudo umount mnt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: eflasher-${{ github.run_number }}
          name: "EFlasher Build ${{ github.run_number }}"
          draft: false
          prerelease: false
          files: eflasher.img
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
